var data1 =[{
             "id" : "1",  
             "title": "admire",  
			 "type":"match",
			 "score":0.5,
             "options":[
             				{"name":"仰慕"},
             				{"name":"到来"},
             				{"name":"进步"},
             				{"name":"带领"}
						],
			"right":1
	
        },{  
             "id" : "2",  
             "title": "适合的，恰当的",  
			 "type":"match",
			 "score":0.5,
             "options":[
				{"name":"approximate"},
				{"name":"appropriate"},
				{"name":"approach"},
				{"name":"apprehend"}
							 ],
			"right":2
        },{  
             "id" : "3",  
             "title": "bounce",  
			 "type":"match",
			 "score":0.5,
             "options":[
				{"name":"注定"},
				{"name":"出生"},
				{"name":"弹跳"},
				{"name":"称重"}
							 ],
							 "right":3
        },{  
             "id" : "4",  
             "title": "商业的",  
			 "type":"match",
			 "score":0.5,
             "options":[
				{"name":"command"},
				{"name":"commend"},
				{"name":"commercial"},
				{"name":"comrade"}
							 ],
			"right":3
        },{  
             "id" : "5",  
             "title": "conservation",  
			 "type":"match",
			 "score":0.5,
             "options":[
				{"name":"服务"},
				{"name":"保留"},
				{"name":"对话"},
				{"name":"保护"}
							 ],
			"right":4
        },{  
			"id" : "6",  
			"title": "装饰",  
			"type":"match",
			"score":0.5,
			"options":[
			   {"name":"decoration"},
			   {"name":"deconstruct"},
			   {"name":"demonstration"},
			   {"name":"decade"}
							],
		   "right":1
	   },{  
		"id" : "7",  
		"title": "accustomed",  
		"type":"match",
		"score":0.5,
		"options":[
		   {"name":"海关的"},
		   {"name":"习惯的"},
		   {"name":"顾客的"},
		   {"name":"消费的"}
						],
	   "right":2
   },{  
	"id" : "8",  
	"title": "主导的",  
	"type":"match",
	"score":0.5,
	"options":[
	   {"name":"donimico"},
	   {"name":"domain"},
	   {"name":"dominant"},
	   {"name":"dorm"}
					],
   "right":3
},{  
	"id" : "9",  
	"title": "grain",  
	"type":"match",
	"score":0.5,
	"options":[
	   {"name":"克"},
	   {"name":"磨坊"},
	   {"name":"暴雨"},
	   {"name":"谷物"}
	],
   "right":4
},{  
	"id" : "10",  
	"title": "大陆",  
	"type":"match",
	"score":0.5,
	"options":[
	   {"name":"continent"},
	   {"name":"continuent"},
	   {"name":"commitment"},
	   {"name":"contemplate"}
	],
   "right":1
},{
	"id" : "11",  
	"title": "desert",  
	"type":"match",
	"score":0.5,
	"options":[
		{"name":"荒漠化"},
		{"name":"遗弃"},
		{"name":"发射"},
		{"name":"插入"}
	],
   "right":2
},{
	"id" : "12",  
	"title": "进化",  
	"type":"match",
	"score":0.5,
	"options":[
	   {"name":"involve"},
	   {"name":"evaluate"},
	   {"name":"evolve"},
	   {"name":"invade"}
	],
   "right":3
},{  
	"id" : "13",  
	"title": "extend",  
	"type":"match",
	"score":0.5,
	"options":[
	   {"name":"尝试"},
	   {"name":"搭帐篷"},
	   {"name":"变成十倍"},
	   {"name":"延展"}
					],
					"right":4
},{  
	"id" : "14",  
	"title": "使石化",  
	"type":"match",
	"score":0.5,
	"options":[
	   {"name":"fossilize"},
	   {"name":"crystallize"},
	   {"name":"industrialize"},
	   {"name":"patronize"}
					],
   "right":1
},{  
	"id" : "15",  
	"title": "canyon",  
	"type":"match",
	"score":0.5,
	"options":[
	   {"name":"罐头"},
	   {"name":"峡谷"},
	   {"name":"洋葱"},
	   {"name":"加农炮"}
					],
   "right":2
},{
   "id" : "16",  
   "title": "残骸",  
   "type":"match",
   "score":0.5,
   "options":[
	  {"name":"deprive"},
	  {"name":"debrief"},
	  {"name":"debris"},
	  {"name":"deficit"}
				   ],
  "right":3
},{  
"id" : "17",  
"title": "disperse",  
"type":"match",
"score":0.5,
"options":[
  {"name":"绝望"},
  {"name":"喷射"},
  {"name":"破产"},
  {"name":"消散"}
			   ],
"right":4
},{  
"id" : "18",  
"title": "提升",  
"type":"match",
"score":0.5,
"options":[
{"name":"enhance"},
{"name":"enforce"},
{"name":"enigma"},
{"name":"enfold"}
		   ],
"right":1
},{  
"id" : "19",  
"title": "domestic",  
"type":"match",
"score":0.5,
"options":[
{"name":"顶点的"},
{"name":"内部的"},
{"name":"厄运的"},
{"name":"装饰的"}
		   ],
"right":2
},{  
"id" : "20",  
"title": "相等的",  
"type":"match",
"score":0.5,
"options":[
{"name":"equivocal"},
{"name":"equerry"},
{"name":"equivalent"},
{"name":"elabrate"}
		   ],
"right":3
},{
	"id" : "1",  
	"title": "The flag is risen each morning over government buildings in Washington.",  
	"type":"single",
	"score":1,
	"options":[
					{"name":"The flag is risen each morning over government buildings in Washington."},
					{"name":"Each morning the flag is rising over government buildings in Washington."},
					{"name":"The flag is raised each morning over government buildings in Washington."},
					{"name":"The flag is raised each morning over government buildings in Washington."}
				],
   "right":3

},{  
	"id" : "2",  
	"title": "Scientists predict technological changes in the next century, they will be as dramatic as was the development of the transcontinental railroad in the last century.",  
	"highlight": "century, they will be as dramatic as was", 
	"type":"single",
	"score":1,
	"options":[
	   {"name":"century, they will be as dramatic as was"},
	   {"name":"century, these will be as dramatic as"},
	   {"name":"century; being as dramatic as was"},
	   {"name":"century as dramatic as"}
					],
   "right":4
},{  
	"id" : "3",  
	"title": "Whether the ancient Egyptians actually sailed or did not to South America remains uncertain, but Heyerdahl's Ra II expedition demonstrated that they could have done so.",  
	"type":"single",
	"highlight":"Whether the ancient Egyptians actually sailed or did not",
	"score":1,
	"options":[
	   {"name":"Whether the ancient Egyptians actually sailed or did not"},
	   {"name":"Whether in actuality the ancient Egyptians sailed or did not"},
	   {"name":"The actuality of the sailing by the ancient Egyptians"},
	   {"name":"That ancient Egyptians actually sailed"}
					],
					"right":4
},{  
	"id" : "4",  
	"title": "It is a myth that mathematicians are so absorbed with abstractions and thus have no practical interests.",  
	"type":"single",
	"highlight":"It is a myth that mathematicians are so absorbed with abstractions and thus",
	"score":1,
	"options":[
	   {"name":"It is a myth that mathematicians are so absorbed with abstractions and thus"},
	   {"name":"It is a myth that mathematicians are absorbed by abstractions and therefore"},
	   {"name":"It is a myth that mathematicians are so absorbed in abstractions that they"},
	   {"name":"It is a myth if mathematicians are absorbed in so much abstraction that they"}
					],
   "right":3
},{  
	"id" : "5",  
	"title": "The origins of the Teapot Dome scandal can be traced to the presidency of Theodore Roosevelt, William Howard Taft, and Woodrow Wilson.",  
	"type":"single",
	"highlight":"can be traced to the presidency of ",
	"score":1,
	"options":[
	   {"name":"can be traced to the presidency of"},
	   {"name":"can be traced to the presidencies of"},
	   {"name":"happened in the presidency of"},
	   {"name":"happening during the presidencies of"}
					],
   "right":2
},{  
   "id" : "6",  
   "title": "An expedition was sent in 1949 to check a Turkish villager's reporting he had seen the remains of Noah's ark on Mount Ararat.",  
   "type":"single",
   "highlight":"a Turkish villager's reporting",
   "score":1,
   "options":[
	  {"name":"a Turkish villager's reporting"},
	  {"name":"the report of a Turkish villager that"},
	  {"name":"the reporting of a Turkish villager"},
	  {"name":"that a Turkish villager who reported"}
				   ],
  "right":2
},{  
"id" : "7",  
"title": "Until being widely hunted for its ivory and blubber the eighteenth century, walruses were plentiful in the waters of the northeastern United States.",  
"type":"single",
"highlight":"Until being widely hunted for its",
"score":1,
"options":[
  {"name":"Until being widely hunted for its"},
  {"name":"Being having been widely hunted for its"},
  {"name":"Up to them being widely hunted for their"},
  {"name":"Until they were widely hunted for their"}
			   ],
"right":4
},{  
"id" : "8",  
"title": "The Women's Media Group recently launching an intern program in an effort to encourage minority women to think about careers in publishing and electronic media.",  
"type":"single",
"highlight":"The Women's Media Group recently launching an intern program",
"score":1,
"options":[
{"name":"The Women's Media Group recently launching an intern program"},
{"name":"The Women's Media Group recently would launch an intern program"},
{"name":"Recently launching an intern program, the Women's Media Group"},
{"name":"The Women's Media Group recently launched an intern program"}
		   ],
"right":4
},{  
"id" : "9",  
"title": "There is many challenges associated with starting one's own business.",  
"type":"single",
"highlight":"is many challenges associated",
"score":1,
"options":[
{"name":"is many challenges associated"},
{"name":"is many challenges to associate"},
{"name":"is many challenges associating"},
{"name":"are many challenges associated"}
		   ],
"right":4
},{  
"id" : "10",  
"title": "For as many as twenty years and more Joseph Conrad lived the life of a sailor.",  
"type":"single",
"highlight":"For as many as twenty years and more",
"score":1,
"options":[
{"name":"For not much more than about twenty years"},
{"name":"For a little over twenty years and more"},
{"name":"For twenty years and then some"},
{"name":"For more than twenty years"}
		   ],
"right":1
}
];

var data2 ={
	bigText:`<p>Young chaffinches normally learn only chaffinch song, though Prof. Thorpe found they could be trained to sing the song of a tree pipit (another type of bird), which is very similar to that of their own species. 
	</p>
	<p>In general, however, the constraints on learning which birds have ensure that they only learn songs appropriate to the species to which they themselves belong. These constraints may be in their brain’s circuitry, the young bird hatching with a rough idea of the sounds that it should copy. 
	</p>
	<p>The crude song of a bird reared in isolation gives some clues as to what this rough idea may be: the length, the frequency range and the breaking up into notes are all aspects of chaffinch song shared between normal birds and those reared in isolation. In other cases, the constraints are more social, young birds only being prepared to learn from individuals with whom they have social interactions. Thus, in a number of species, it has been found that they will not copy from recordings, but will do so from a live tutor. In some cases, this may occur when they are young birds, but in others the main learning period is when they set up their territories and interact with neighbors for the first time, enabling them to match their neighbor’s songs and so countering with them. Whatever the nature of the learning rules in a particular species, there is no doubt that they are effective; it is very unusual to hear a wild bird singing a song which is not typical of its own species despite the many different songs which often occur in a small patch of woodland.</p>`,
	readQuestion : [ {
		"id" : "1",  
		"title": "The word enabling in the passage is closet in meaning to",  
		"type":"match",
		"score":1,
		"options":[
			{"name":"allowing"},
			{"name":"challenging"},
			{"name":"forcing"},
			{"name":"preparing"}
					],
	   "right":1
	
	},{  
		"id" : "2",  
		"title": "It can be inferred from the paragraph that one of the functions of songs in birds is to",  
		"type":"match",
		"score":1,
		"options":[
			{"name":"bring together birds living in groups with birds living in isolation"},
			{"name":"help young birds distinguish other young birds from adults"},
			{"name":"make possible interactions between birds of different species"},
			{"name":"help birds to establish territories"}
						],
	   "right":4
	},{  
		"id" : "3",  
		"title": "Which of the sentences below best expresses the essential information in the highlighted sentence in the passage? Incorrect choices change the meaning in important ways or leave out essential information.",  
		"type":"match",
		"score":1,
		"options":[
			{"name":"Songs produced by chaffinches reared in isolation are cruder than the songs of wild birds."},
			{"name":"The song of a bird reared in isolation suggests which aspects of chaffinch song may be inborn."},
			{"name":"Comparing the crude songs of chaffinches reared in isolation to the songs of wild chaffinches suggests differences as well as similarities."},
			{"name":"Studying the song aspects of chaffinches reared in isolation, researchers have gained a better understanding of the songs produced by wild birds."}
						],
	   "right":2
	},{  
		"id" : "4",  
		"title": "According to the paragraph, in some species, young birds do not copy songs from recordings because",  
		"type":"match",
		"score":1,
		"options":[
			{"name":"they learn to sing only by live interactions with other birds"},
			{"name":"their ability to learn from recordings occurs later in life"},
			{"name":"they can only learn the songs of the birds living in their area of woodland"},
			{"name":"they can only learn songs from other birds of their own species"}
						],
	   "right":1
	},{  
		"id" : "5",  
		"title": "What is the main idea of this paragraph?",  
		"type":"match",
		"score":1,
		"options":[
			{"name":"The limitations of song learning on young birds make them typically sing their own songs."},
			{"name":"Young birds learn their songs from their neighbors mainly."},
			{"name":"Birds reared in isolation learn their songs differently from those reared in normal conditions."},
			{"name":"Scientist have successfully trained birds to learn the songs of other bird species’. "}
						],
	   "right":1
	}
	],
	listenQuestion:[ {
		"id" : "1",  
		"title": " Why does the student go to see the professor? ",  
		"type":"match",
		"score":1,
		"options":[
			{"name":"To report on the research he has done"},
			{"name":"To ask for permission to observe a class"},
			{"name":"To get help understanding an assignment "},
			{"name":"To ask about a question on a recent test"}
					],
	   "right":3
	
	},{  
		"id" : "2",  
		"title": "According to the professor, what should the student do after completing the first observation?",  
		"type":"match",
		"score":1,
		"options":[
			{"name":"Look for another child to observe"},
			{"name":"Research the child's developmental stage"},
			{"name":"Report his progress to the class"},
			{"name":"Submit the notes he took during the observation"}
						],
	   "right":2
	},{  
		"id" : "3",  
		"title": "Why does the student mention a child playing with a toy car?",  
		"type":"single",
		"score":1,
		"options":[
			{"name":"To identify a behavior that would show a child's imagination developing"},
			{"name":"To identify a behavior that might illustrate egocentric thinking"},
			{"name":"To give an example of a behavior he has observed"},
			{"name":"To give an example of a behavior he would not need to describe"}
						],
	   "right":1
	},{  
		"id" : "4",  
		"title": "Why should the student contact the education department secretary? ",  
		"type":"single",
		"score":1,
		"options":[
			{"name":"Her child attends a school run by the university. "},
			{"name":"She has a list of families that might be able to help the man. "},
			{"name":"She can contact students who have worked on a similar project. "},
			{"name":"She will explain how to observe a class without disturbing it."}
						],
	   "right":2
	},{  
		"id" : "5",  
		"title": "All we have to do is do two observation and ____________, right?",  
		"type":"single",
		"score":1,
		"options":[
			{"name":"21121"},
			{"name":"12121"},
			{"name":"211222"},
			{"name":"tt22212121tt"}
						],
	   "right":3
	}
	],
}

function Toelf(questions, after){
	this.questions = questions;
	this.init(questions);
	// 十分钟
	this.limit = 600;
	this.after = after;
}

Toelf.prototype.init = function(questions){
	let that = this;
	that.index = 1;
	that.whole = questions.length;
	that.score = {};
	that.start = +new Date();
	that.timer = setInterval(function(){
		that.countDown()
	},1000);
	that.box = $('#question-box');
	this.renderAll();
	this.activeQuestion(1);	
}

Toelf.prototype.answer = function(type, score){
	if(!this.score[type]){
		this.score[type] = 0
	}
	this.score[type] += score;
}

Toelf.prototype.countDown = function(){
	let elapse = parseInt((+new Date() - this.start)/1000);
	let left = this.limit - elapse;
	if(left > 0){
		//渲染倒计时
		let time = moment(left*1000).format('mm:ss');
		$('#question .t-time').text(time);
	}else{
		// 超时
		this.abort();
	}
}

Toelf.prototype.abort = function(){
	clearInterval(this.timer);
	this.after.call(this, this.score);
}

Toelf.prototype.nextQuestion = function(){
	
	if(this.index === this.whole){
		this.abort();
	}else{
		this.index += 1;
		this.activeQuestion(this.index);
	}

}

Toelf.prototype.renderAll = function(){

	let templates = {
		'match': `
		<div class="entrance-bottom-frame-line">
			<div class="entrance-bottom-frame-line-type">
			中英文匹配题</div>
			<div class="entrance-bottom-frame-line-title center">
			{{title}}</div>
			
			{% for item in options %}
				{% if loop.index === right %}
				<div class="entrance-bottom-frame-line-button" data-score={{score}} data-type={{type}}>
				<div class="entrance-bottom-frame-line-button-id">{{eums[loop.index-1]}}.</div>
				<div class="entrance-bottom-frame-line-button-frame">{{item.name}}</div>
			</div>

				{% else %}
						<div class="entrance-bottom-frame-line-button" data-score={{0}}  data-type={{type}}>
						<div class="entrance-bottom-frame-line-button-id">{{eums[loop.index-1]}}.</div>
						<div class="entrance-bottom-frame-line-button-frame">{{item.name}}</div>
					</div>
				{% endif %}
			{% endfor %}
		</div>
		`,
		'single': `
		<div class="entrance-bottom-frame-line">
			<div class="entrance-bottom-frame-line-type">
			单项选择题</div>
			<div class="entrance-bottom-frame-line-title left">
			{{title}}</div>
			{% for item in options %}
			
				{% if loop.index === right %}
				<div class="entrance-bottom-frame-line-button" data-score={{score}} data-type={{type}}>
				<div class="entrance-bottom-frame-line-button-id">{{eums[loop.index-1]}}.</div>
				<div class="entrance-bottom-frame-line-button-frame">{{item.name}}</div>
			</div>

				{% else %}
						<div class="entrance-bottom-frame-line-button" data-score={{0}}  data-type={{type}}>
						<div class="entrance-bottom-frame-line-button-id">{{eums[loop.index-1]}}.</div>
						<div class="entrance-bottom-frame-line-button-frame">{{item.name}}</div>
					</div>
				{% endif %}
			{% endfor %}
		</div>
		`,
	}
	let html = '';
	this.questions.forEach((question)=>{
		let eums = ['A', 'B', 'C', 'D'];
		question.eums = eums;
		html+= nunjucks.renderString(templates[question.type], question);
	});

	this.box.html(html);
	let that = this;

	$(document).delegate('#question .entrance-bottom-frame-line-button','click', function(){
		let $this = $(this);
		$(this).addClass('active').siblings().removeClass('active');
		that.answer($this.attr('data-type'), Number($this.attr('data-score')));
		that.nextQuestion();
	});
	
}

Toelf.prototype.activeQuestion = function(index){
	let qu = this.box.find('.entrance-bottom-frame-line').eq(index-1);
	qu.addClass('active').siblings().removeClass('active');
	this.box.css('marginLeft',-(this.index-1)*100 + "%");
	
	document.querySelector("#question .topic-frameli").innerHTML = "<div>" + index + "</div>" + "/" + this.whole;
	$('.process-top').css('width', index * 100 / this.whole + '%' );
	let highlight = this.questions[index-1].highlight;
	if(highlight){
		let replace = qu.html().replace(highlight,"<span class=\"underline\">"+highlight+"</span>");
		qu.html(replace);
		//qu.html(qu.html().replace(highlight,"<h3>"+highlight+"</h3>"))
	}
}

function ToelfAdvance(questions,score, after){
	this.questions = questions;
	this.init(questions, score);
	// 十分钟
	this.limit = 600;
	this.after = after;
}

ToelfAdvance.prototype.init = function(questions, score){
	let that = this;
	that.readIndex = 1;
	that.listenIndex = 1;
	that.readwhole = questions.readQuestion.length;
	that.listenwhole = questions.listenQuestion.length;
	that.whole = that.readwhole + that.listenwhole;
	that.score = score || {};
	that.start = +new Date();
	that.timer = setInterval(function(){
		that.countDown();
	},1000);
	that.box = $('#read-question-box');
	that.listenBox = $('#listen-question-box');
	that.renderAllReadQuestion();
	that.bindAction();
	that.activeReadQuestion(that.readIndex);
}


ToelfAdvance.prototype.answer = function(type, score){
	if(!this.score[type]){
		this.score[type] = 0
	}
	this.score[type] += score;
}

ToelfAdvance.prototype.countDown = function(){
	let elapse = parseInt((+new Date() - this.start)/1000);
	
	let left = this.limit - elapse;

	if(left > 0){
		//渲染倒计时
		let time = moment(left*1000).format('mm:ss');
		$('#question2 .t-time').text(time);
	}else{
		// 超时
		this.abort();
	}
}

ToelfAdvance.prototype.abort = function(){
	this.countScore();
	console.log(this.score);
	clearInterval(this.timer);
	this.after.call(this, this.score);
}
ToelfAdvance.prototype.countScore = function(){
	const that = this;
	$('#read-question-box').find('.entrance-bottom-frame-line-button.active').each(function(d){
		if(!that.score['read']){
			that.score['read'] = 0
		}
		that.score['read'] += Number($(this).attr('data-score'));
	});
}

ToelfAdvance.prototype.nextQuestion = function(){
	
}

ToelfAdvance.prototype.renderAllReadQuestion = function(){
	const that = this;
	$('.bigtext').each(function(){
		$(this).html(that.questions.bigText);
	});

	let template = `<div class="read-question"><div class="entrance-bottom-frame-line-title">
	{{id}}.{{title}}</div>
	
	{% for item in options %}
		{% if loop.index === right %}
		<div class="entrance-bottom-frame-line-button" data-score={{score}} data-type={{type}}>
		<div class="entrance-bottom-frame-line-button-id">{{eums[loop.index-1]}}.</div>
		<div class="entrance-bottom-frame-line-button-frame">{{item.name}}</div>
	</div>

		{% else %}
				<div class="entrance-bottom-frame-line-button" data-score={{0}}  data-type={{type}}>
				<div class="entrance-bottom-frame-line-button-id">{{eums[loop.index-1]}}.</div>
				<div class="entrance-bottom-frame-line-button-frame">{{item.name}}</div>
			</div>
		{% endif %}
	{% endfor %}</div>`

	let html = '';
	this.questions.readQuestion.forEach((question)=>{

		let eums = ['A', 'B', 'C', 'D'];
		question.eums = eums;
		html+= nunjucks.renderString(template, question);
	});

	this.box.html(html);
}


ToelfAdvance.prototype.renderAllListenQuestion = function(){
	const that = this;

	let template = `<div class="listen-question"><div class="entrance-bottom-frame-line-title">
	{{id}}.{{title}}</div>
	
	{% for item in options %}
		{% if loop.index === right %}
		<div class="entrance-bottom-frame-line-button" data-score={{score}}>
		<div class="entrance-bottom-frame-line-button-id">{{eums[loop.index-1]}}.</div>
		<div class="entrance-bottom-frame-line-button-frame">{{item.name}}</div>
	</div>

		{% else %}
				<div class="entrance-bottom-frame-line-button" data-score={{0}}>
				<div class="entrance-bottom-frame-line-button-id">{{eums[loop.index-1]}}.</div>
				<div class="entrance-bottom-frame-line-button-frame">{{item.name}}</div>
			</div>
		{% endif %}
	{% endfor %}</div>`

	let html = '';
	this.questions.listenQuestion.forEach((question)=>{

		let eums = ['A', 'B', 'C', 'D'];
		question.eums = eums;
		html+= nunjucks.renderString(template, question);
	});

	this.listenBox.html(html);
}

ToelfAdvance.prototype.bindAction = function(){

	let that = this;

	$('.listenpanel').hide();

	$('.readpanel').hide().siblings().not('.listenpanel').show();

	$('#start-read').on('click', function(){
		let $this = $(this);
		$this.parent().hide().siblings().hide();
		$('.readpanel').show();
		//that.answer($this.attr('data-type'), Number($this.attr('data-score')));
		//that.nextQuestion()

		$('.paneltab li').eq(1).addClass('active').siblings().removeClass('active');
		$('.panelbox .panel').eq(1).addClass('active').siblings().removeClass('active');

	});

	$('.paneltab li:first-child').addClass('active');

	$('.paneltab li').on('click', function(){
		let index = $(this).index();
		$(this).addClass('active').siblings().removeClass('active');
		console.log(index);
		$('.panelbox .panel').eq(index).addClass('active').siblings().removeClass('active');
	});

	$('.panel .entrance-bottom-frame-line-button').on('click', function(){
		$(this).addClass('active').siblings().removeClass('active');
	});

	// 上一题
	$('#pre-button').on('click', function(){
		let index = that.readIndex;
		that.readIndex -=1
		that.activeReadQuestion(index-1);
	});
	// 下一题
	$('#next-button').on('click', function(){
		let index = that.readIndex;
		that.readIndex +=1;
		that.activeReadQuestion(index+1);
	});

	$('#submit-read').on('click', function(){
		let dialog = $(document).dialog({
			titleText: '',
			type : 'confirm',
			closeBtnShow: false,
			buttons: [          
				{
					name: '确认',
					callback: function() {
						that.bindListenAction();
					}
				},
				{
					name: '取消',
					callback: function() {
						dialog.close();
					}
				},
			],
			content: '提交阅读理解，即将进入听力部分',
		});
	});


}


ToelfAdvance.prototype.bindListenAction = function(){

	let that = this;
	$('.readpanel').hide();
	$('.listenpanel').show();
	this.renderAllListenQuestion();
	this.activeListenQuestion(this.listenIndex);

	//fix bug
	$('#listen-question-box').insertAfter('.audiojs');
	$('.listenpanel .operation-box').insertAfter('#listen-question-box');

	

	$('.listenpanel .entrance-bottom-frame-line-button').on('click', function(){
		//防重复点击
		if(!that.listenActive){
			return
		}
		$(this).addClass('active').siblings().removeClass('active');
		that.listenActive = false;
		let index = that.listenIndex;
		that.listenIndex +=1;
		that.answerListen(Number($(this).attr('data-score')));
		setTimeout(function(){
			that.activeListenQuestion(index+1);
		},1000);
	});

	$('#submit-listen').on('click', function(){
		that.abort();
	});
}



ToelfAdvance.prototype.activeReadQuestion = function(index){
	document.querySelector("#question2 .topic-frameli").innerHTML = "<div>" + index + "</div>" + "/" + this.whole;
	$('.process-top').css('width', Number(index) * 100 / this.whole + '%' );
	this.box.find('.read-question').eq(index-1).addClass('active').siblings().removeClass('active');
	$('#next-button').show();
	$('#pre-button').show();
	$('#submit-read').hide();
	if(index === 1){
		$('#pre-button').hide();
	}
	if(index === this.readwhole){
		$('#next-button').hide();
		$('#submit-read').show();
	}
}

ToelfAdvance.prototype.answerListen = function(score){
	if(!this.score['listen']){
		this.score['listen'] = 0
	}
	this.score['listen'] += score;
}


ToelfAdvance.prototype.activeListenQuestion = function(index){
	if(index > this.listenwhole){
		$('#submit-listen').removeClass('disabled');
		return;
	}
	document.querySelector("#question2 .topic-frameli").innerHTML = "<div>" + (Number(index) + Number(this.readwhole)) + "</div>" + "/" + this.whole;
	
	$('.process-top').css('width', (Number(index) + Number(this.readwhole)) * 100 / this.whole + '%' );
	
	this.listenBox.find('.listen-question').eq(index-1).addClass('active').siblings().removeClass('active');
	$('#submit-listen').parent('.operation-box').hide();
	if(index === this.listenwhole){
		$('#submit-listen').addClass('disabled');
		$('#submit-listen').parent('.operation-box').show();
	}
	this.listenActive = true;
}

ToelfAdvance.prototype.show = function(){
	console.log()
}


/*
ToelfAdvance.prototype.activeQuestion = function(index){
	this.box.find('.entrance-bottom-frame-line').eq(index-1).addClass('active').siblings().removeClass('active');
	this.box.css('marginLeft',-(this.index-1)*100 + "%");
	
	document.querySelector(".topic-frameli").innerHTML = "<div>" + index + "</div>" + "/" + this.whole;
}*/


function countToelf(score){

	/*
	
		{
			wholeScore:30,
			listen: 15,
			read:15,
			speak:15,
			write:15
		}
	*/
	let wholeScore = score.wholeScore || 0;

	let percent = '0%';
	if(wholeScore >=100){
		percent = '90%';
		wordForRecommand = '你已经取得了一个非常可观的托福分数，但是再往上提升需要更高阶段的托福系统学习，建议可以查漏补缺，回归到基础知识的夯实，生僻题目的解题方法，加油！欢迎咨询小客服获得最适合你的学习规划建议哦～';
	}else if(wholeScore >=81){
		percent = '85%%';
		wordForRecommand = '你的托福分数在中等水平以上，建议系统化四科课程的干货知识学习以及托福考点技巧等的运用，加油！';
	}else if(wholeScore >=61){
		percent = '75%';
		wordForRecommand = '你的托福分数达到了一般人的平均水平。在各个学科方面，建议加强基础层面的训练，从而获得信息的整合能力，对考点的预判能力。建议你开始进行托福强化学习，加油！';
	}else if(wholeScore >=41){
		percent = '40%';
		wordForRecommand = '你的英语能力达到了托福学习的基础要求，但是距离托福高分很远的距离。建议你开始进行系统化的托福学习，加油！';
	}else if(wholeScore >0){
		percent = '30%';
		wordForRecommand = '你的英语能力与托福高分有较大的差距，建议你可以花更多时间在基础能力提升上.';
	}else{
		percent = '0%';
		wordForRecommand = '未填写托福分数哦！';
	}
	
	let readAb = score.read || 0;
	let writeAb = score.write || 0;
	let listenAb = score.listen || 0;
	let speakAb = score.speak || 0;

	let readText, writeText, listenText, speakText;

	if(readAb >= 22){
		readText = '你具有广泛的阅读能力，一般能够理解较难文本的英语学术文章，掌握了大量的学术词汇和良好的语法结构';
	}else if(readAb >= 15){
		readText = '你通常都能理解学术英语的文章，但是在理解的某些部分文本有局限性：在理解高层次上的复杂词汇仍有一定的困难';
	}else{
		readText = '你的阅读能力非常有限，亟待提升，你只能理解文章中部分信息：你对较不常见词汇的理解不一致，理解和连接信息的能力有限';
	}

	if(writeAb >= 22){
		writeText = '你能够很好得结合演讲和阅读回答问题，但对一些要点的总结有些不准确，或在口语的表达上有时不符合语法或不清楚。';
	}else if(writeAb >= 15){
		writeText = '你能够把讲课内容和阅读材料联系起来，但你的一个或多个重要的想法可能缺失、不清晰或不准确;可能不清楚讲座和阅读文章之间的关系;';
	}else{
		writeText = '你未能理解演讲内容和阅读文章;讲座与阅读文章的联系不足;或许有多语法错误和非常不清楚的表达和句子结构';
	}
	
	if(listenAb >= 22){
		listenText = '你具有广泛的听力能力，包括能够听懂复杂的词汇和文章结构：你能够理解文章中不管是隐含的还是陈述的主要观点和重要细节,区分重要的和次要的信息';
	}else if(listenAb >= 15){
		listenText = '你通常都能听懂英语对话和讲座，但是可能难以理解主要思想或不重要的细节；你能综合演讲或对话中相邻部分的信息，但可能难以从不同的部分综合信息演讲或对话内容';
	}else{
		listenText = '你能够理解文章的主旨和主要细节信息，但在理解涉及抽象或复杂概念的英语演讲和对话以及识别这些概念之间的关系方面存在困难';
	}
	
	if(speakAb >= 22){
		speakText = '你有能力用英语有效地交流你的个人经历和观点。总的来说，你的演讲清晰流畅。你对词汇和语法的运用是有效的，只有很小的错误。';
	}else if(speakAb >= 15){
		speakText = '你能用英语表达你的个人经历和观点，而且大多清晰连贯。你的发言很清楚，只是偶尔有错误。语法和词汇有一定的局限性，并包含一些错误。';
	}else{
		speakText = '你能够用英语讲述日常经历和观点方面有些困难。听众有时会因为发音、语法和词汇方面的明显问题而难以理解。';
	}
	let rank;
	if(true){
		rank = 1;
	}else{
		rank = 0;
	}
	return {
		rank,
		wholeScore,
		speakAb,
		writeAb,
		readAb,
		listenAb,
		speakText,
		writeText,
		readText,
		listenText,
		percent,
		wordForRecommand
	}	
}


function count(score){

	let words = 0;
	//计算词汇量

	if(score.match >= 9){
		words = 4000;
	}else if(score.match >= 7){
		words = 3000;
	}else if(score.match >= 5){
		words = 2000;
	}else if(score.match >= 3){
		words = 1500;
	}else if(score.match >= 0.5){
		words = 1200;
	}else{
		words = 0;
	}

	if(!score.match){
		score.match = 0;
	}
	if(!score.single){
		score.single = 0;
	}
	if(!score.read){
		score.read = 0;
	}
	if(!score.listen){
		score.listen = 0;
	}

	let wholeScore = score.match + score.single + score.read + score.listen;
	let percent;

	let wordForRecommand = '你的英语能力相当的扎实，建议可以加强托福的系统化学习，争取早日解决托福，加油！欢迎咨询小客服获得最适合你的学习规划建议哦～';
	let toelfScore = '0'
	if(wholeScore >=28.5){
		percent = '90%';
		toelfScore = '60+';
		wordForRecommand = '你的英语能力相当的扎实，建议可以加强托福的系统化学习，争取早日解决托福，加油！欢迎咨询小客服获得最适合你的学习规划建议哦～';
	}else if(wholeScore >=25){
		percent = '70%';
		toelfScore = '55+';
		wordForRecommand = '你的英语基础已经达到了托福学习的基本要求，但是不论在词汇、语法、听力、阅读都有一定的欠缺。建议你早日开始托福的基础学习，从而夯实高分基础，加油！欢迎咨询小客服获得最适合你的学习规划建议哦～';
	}else if(wholeScore >=20){
		percent = '56%';
		toelfScore = '50+';
		wordForRecommand = '你的英语能力达到了托福初学者的平均水平。在各个学科方面，建议加强基础层面的训练，从而获得信息的整合能力，对考点的预判能力。建议你开始进行系统化的托福学习，加油！欢迎咨询小客服获得最适合你的学习规划建议哦～';
	}else if(wholeScore >=15){
		percent = '40%';
		toelfScore = '45+';
		wordForRecommand = '你的英语能力达到了托福学习的基础要求，但是距离托福高分很远的距离。建议你可以加强托福基础的学习，基础层面能力是获得高分的关键。欢迎咨询小客服获得最适合你的学习规划建议哦～';
	}else if(wholeScore >=1){
		percent = '30%';
		toelfScore = '40+';
		wordForRecommand = '你的英语能力与托福高分有较大的差距，建议你可以花更多时间在基础能力提升上。欢迎咨询小客服获得最适合你的学习规划建议哦～';
	}else{
		percent = '0%';
		toelfScore = '0+';
		wordForRecommand = '没有完成测试老师不能给你评语哦～';
	}
	

	// 计算能力值

	let wordAb = 10 * (score.match/10);
	let graAb = 10 * (score.single/10);
	let readAb = 10 * (score.read/5);
	let listenAb = 10 * (score.listen/5);

	let wordText, graText, readText, listenText;

	if(wordAb >= 9){
		wordText = '恭喜你，你的词汇量已经达到了托福基础要求。但是不要骄傲。想要达到托福高分需要具备10000左右的词汇量。建议采用一些词汇速记法来快速掌握大量单词';
	}else if(wordAb >= 7){
		wordText = '你的词汇目前掌握的还不错，达到了学习托福的基本要求，但是错误的几个题目说明了你的词汇掌握的还不够扎实，之后需要努力学习。建议采用一些词汇速记法来快速掌握大量单词';
	}else if(wordAb >= 5){
		wordText = '你的词汇量在同龄人中处于平均水平，但是托福高分需要具备10000左右的词汇量，你还有很长的一段路要走。建议采用一些词汇速记法来快速掌握大量单词。';
	}else if(wordAb >= 3){
		wordText = '你的词汇量略微有一些不足，但是通过掌握一些词汇速记技巧，相信可以快速掌握大量单词';
	}else if(wordAb >= 0.5){
		wordText = '你的词汇量相比其他学生有一定的劣势，建议马上开始准备词汇的学习。建议采用一些词汇速记法来快速掌握大量单词。';
	}else{
		wordText = '你需要花费更多时间来完成基础的单词背诵才能应对托福挑战哦～推荐你从现在开始，翻开单词书来一场背单词战斗吧！';
	}

	if(graAb >= 9){
		graText = '你的语法能力已经达到了托福基础要求。但是真实的托福考试会涉及到大量长难句的理解，建议你进行体系化的学习来掌握更高阶的语法能力';
	}else if(graAb >= 7){
		graText = '你的语法能力相比同龄人有一定的优势，但是真实的托福考试会涉及到大量长难句的理解，建议你进行体系化的学习来掌握更高阶的语法能力';
	}else if(graAb >= 4){
		graText = '你的语法能力亟待提升，尽管你在同龄人处于平均水平，但是真实的托福考试会涉及到大量长难句的理解，建议你进行体系化的学习来掌握更高阶的语法能力';
	}else if(graAb >= 1){
		graText = '你的语法能力亟待提升，真实的托福考试会涉及到大量长难句的理解，建议你进行体系化的学习来掌握更高阶的语法能力';
	}else{
		graText = '长难句是托福考试中的一道拦路虎，如果不能尽早的及时解决，将会极大的影响你的最终考试成绩哦！';
	}

	if(readAb >= 4){
		readText = '你的阅读表现相对优秀;从测试结果来看，你可以把握文章的大意并且抓取重要细节信息，对于托福学习来说你的基础很扎实，建议你可以尝试做更长篇章的阅读，获得更准确的能力评估。';
	}else if(readAb >= 2){
		readText = '你的阅读能力亟待提升;从测试结果来看，托福阅读对你来说相对偏难。你对文章的理解还停留在字面意思，不能很好的进行总结，无法很好的梳理其中的细节关系，这将会影响你在做阅读的时候的实际表现，建议你现在就开始系统化的学习托福。';
	}else if(readAb >= 1){
		readText = '你的阅读能力亟待提升;从测试结果来看，托福阅读对你来说是一个挑战。你对文章的基本字面意思的理解还有一定的困难。一般来说，你的词汇量与语法扎实程度决定了你的阅读能力。建议你需要从现在开始进行托福的系统化学习。';
	}else{
		readText = '从测试结果来看，托福阅读对你是一个巨大的挑战。这很可能是由于你的词汇量及语法能力还没有达到托福的基本要求。建议可以同时进行长难句语法以及词汇的学习。';
	}

	if(listenAb >= 4){
		listenText = '本次听力测试，你的表现相对优秀；从测试结果来看，你已经可以提炼出听力材料中的重要信息，符合了托福学习的基础要求，建议可以加大听力训练难度。建议你可以尝试做更长篇章的阅读，获得更准确的能力评估。';
	}else if(listenAb >= 2){
		listenText = '你的听力能力亟待提升;从测试结果来看，你对于音频信息处理能力一般，只能听懂片段式信息，而真实考试中的篇幅会更长。建议你进行针对性的听力训练，克服段落主旨不能掌握的弱点。';
	}else if(listenAb >= 1){
		listenText = '你的听力能力亟待提升;从测试结果来看，你对于音频信息处理能力一般，只能听懂片段式信息，但是程度也有限，不能真甄别出重要细节信息，更无法把段落框架，建议你现在就要开始训练听力能力并补充听力学科背景只是。';
	}else if(listenAb == 0){
		listenText = '从测试结果来看，你并不能很好的理解听力材料并回答问题。一方面是因为你不熟悉托福的考试形式，另一方面也是因为基础听力能力需要训练，建议你现在就要开始训练听力能力并补充听力学科背景只是。';
	}

	
	// 评分等级
	let rank;
	if(score.rank){
		rank = 1;
	}else{
		rank = 0;
	}

	return {
		rank,
		words,
		toelfScore,
		wordAb,
		graAb,
		readAb,
		listenAb,
		wordText,
		graText,
		readText,
		listenText,
		percent,
		wordForRecommand
	}
}



function renderScoreTemplate(data){

	let template = `<div class="entrance-bottom">
				
	<div class="card">
		<img src="" alt="" class="card-image">
		<div class="card-text-box">
			<h4>词汇量</h4>
			<span class="card-number">{{words}}</span>
			<hr>
			<h4>托福分数预估</h4>
			<span class="card-number">{{toelfScore}}</span>
			<hr>
			<span class="card-prefix">
					你超过了{{percent}}的测评者！
			</span>
		</div>
	</div>
	<div class="card-title card-title1"></div>
	<div class="card">

		<span class="card-longtext">
				{{wordForRecommand}}
		</span>

		<h3>各项能力</h3>

		<ul>
			<li> 词汇 <span class="process"></span> {{wordAb}}</li>
			<li> 语法 <span class="process"></span>  {{graAb}}</li>
			{% if rank === 1 %}
			<li> 阅读 <span class="process"></span>  {{readAb}}</li>
			<li> 听力 <span class="process"></span>  {{listenAb}}</li>
			{% endif %}
		</ul>

		<h3>名师点评</h3>
		<ul>
			<li> 词汇: <span class="comment">{{wordText}}</span> </li>
			<li> 语法: <span class="comment">{{graText}}</span> </li>
			{% if rank === 1 %}
			<li> 阅读: <span class="comment">{{readText}}</span> </li>
			<li> 听力: <span class="comment">{{listenText}}</span> </li>
			{% endif %}
		</ul>

	</div>

	{% if rank === 1 %}

	<div class="card-title card-title2"></div>
	<div class="card">

		<div class="class-recommand">
			<div class="class-img">
			</div>
			<div class="class-title-box">
					<span class="class-title class-title1">托福</span>
					<span class="class-title class-title2">托福高分突破特训</span>
					<span class="class-title class-title3">1888币</span>
			</div>
			<div class="class-title-box">
					<span class="class-title class-title4">开课时间：2018.09.15 13:00</span>
					<span class="class-title class-title5">80课时</span>
			</div>


		</div>
		<span class="card-longtext">
				你的备考计划已经生成！我们将为你发送详细的报告并有机会领取一次免费1对1备考指导。通过以下方式获取。
		</span>
		<h3>方式一、电话预约</h3>
		<input type="text" placeholder="输入电话领取详细报告和备考指导">  <button class="send">发送</button>
		<h3>方式二、添加老师微信</h3>
		<img src="/assets/img/wechat.png">
		<h4>如有任何问题，欢迎致电咨询或咨询顾问</h4>
		<button class="action-button teacher-button">咨询顾问</button>
		<a class="action-button call-button" href="tel:18248466889">拨打电话</a>
	</div>

	{% endif %}


	{% if rank === 0 %}

		<div class="card-title card-title3"></div>
		<div class="card">
				<span class="card-longtext">
						你的备考计划已经生成！我们将为你发送详细的报告并有机会领取一次免费1对1备考指导。通过以下方式获取。
				</span>
				<h3>方式一、电话预约</h3>
				<input type="text" placeholder="输入电话领取详细报告和备考指导">  <button class="send">发送</button>
				<h3>方式二、添加老师微信</h3>
				<img src="/assets/img/wechat.png">
				<h4>如有任何问题，欢迎致电咨询或咨询顾问</h4>
				<button class="action-button teacher-button">咨询顾问</button>
				<a class="action-button call-button" href="tel:18248466889">拨打电话</a>
		</div>
	{% endif %}


</div>`


let html = nunjucks.renderString(template, data);
	$('#landing-detail').html(html);
}



function renderToeflScoreTemplate(data){

	let template = `<div class="entrance-bottom">
				
	<div class="card">
		<div class="card-toefl-box">
			<h4 class="toefl-score">真考成绩总分{{wholeScore}}分</h4>

			<div>
				<ul class="card-toelf-list-box">
					<li><h4 class="score-title">听力</h4> <h4 class="score">{{listenAb}}</h4></li>
					<li><h4 class="score-title">阅读</h4> <h4 class="score">{{readAb}}</h4></li>
					<li><h4 class="score-title">口语</h4> <h4 class="score">{{speakAb}}</h4></li>
					<li><h4 class="score-title">写作</h4> <h4 class="score">{{writeAb}}</h4></li>
				</ul>
			</div>

			<span class="card-prefix">
					你超过了{{percent}}的测评者！
			</span>
		</div>
	</div>
	<div class="card-title card-title1"></div>
	<div class="card">

		<span class="card-longtext">
				{{wordForRecommand}}
		</span>

		<h3>名师点评</h3>
		<ul>
			<li> 写作: <span class="comment">{{writeText}}</span> </li>
			<li> 口语: <span class="comment">{{speakText}}</span> </li>
			<li> 阅读: <span class="comment">{{readText}}</span> </li>
			<li> 听力: <span class="comment">{{listenText}}</span> </li>
		</ul>

	</div>

	{% if rank === 1 %}

	<div class="card-title card-title2"></div>
	<div class="card">

		<div class="class-recommand">
			<div class="class-img">
			</div>
			<div class="class-title-box">
					<span class="class-title class-title1">托福</span>
					<span class="class-title class-title2">托福高分突破特训</span>
					<span class="class-title class-title3">1888币</span>
			</div>
			<div class="class-title-box">
					<span class="class-title class-title4">开课时间：2018.09.15 13:00</span>
					<span class="class-title class-title5">80课时</span>
			</div>


		</div>
		<span class="card-longtext">
				你的备考计划已经生成！我们将为你发送详细的报告并有机会领取一次免费1对1备考指导。通过以下方式获取。
		</span>
		<h3>方式一、电话预约</h3>
		<input type="text" placeholder="输入电话领取详细报告和备考指导">  <button class="send">发送</button>
		<h3>方式二、添加老师微信</h3>
		<img src="/assets/img/wechat.png">
		<h4>如有任何问题，欢迎致电咨询或咨询顾问</h4>
		<button class="action-button teacher-button">咨询顾问</button>
		<a class="action-button call-button" href="tel:18248466889">拨打电话</a>
	</div>

	{% endif %}


	{% if rank === 0 %}

		<div class="card-title card-title3"></div>
		<div class="card">
				<span class="card-longtext">
						你的备考计划已经生成！我们将为你发送详细的报告并有机会领取一次免费1对1备考指导。通过以下方式获取。
				</span>
				<h3>方式一、电话预约</h3>
				<input type="text" placeholder="输入电话领取详细报告和备考指导">  <button class="send">发送</button>
				<h3>方式二、添加老师微信</h3>
				<img src="/assets/img/wechat.png">
				<h4>如有任何问题，欢迎致电咨询或咨询顾问</h4>
				<button class="action-button teacher-button">咨询顾问</button>
				<a class="action-button call-button" href="tel:18248466889">拨打电话</a>
		</div>
	{% endif %}


</div>`


let html = nunjucks.renderString(template, data);
	$('#landing-detail').html(html);
}